---
- name: Install Python Docker SDK (for community.docker facts/modules)
  ansible.builtin.apt:
    name:
      - python3-docker
    state: present
    update_cache: true
    cache_valid_time: 3600

- name: Gather service facts
  ansible.builtin.service_facts:

- name: Assert Docker service exists
  ansible.builtin.assert:
    that:
      - "'docker.service' in ansible_facts.services"
    fail_msg: "docker.service not found. Install Docker first."

- name: Assert Docker service is running
  ansible.builtin.assert:
    that:
      - ansible_facts.services['docker.service'].state == 'running'
    fail_msg: "docker.service is not running. Start Docker daemon first."

- name: Gather Docker host info (connectivity check)
  community.docker.docker_host_info:
  register: docker_compose_lab_docker_info
  changed_when: false

- name: Assert Docker API reachable
  ansible.builtin.assert:
    that:
      - docker_compose_lab_docker_info is defined
    fail_msg: "Cannot talk to Docker API (socket/permissions)."
