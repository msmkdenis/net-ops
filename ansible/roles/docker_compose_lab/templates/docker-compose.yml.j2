services:
  # --- Исходные сервисы ---
  attacker:
    image: {{ docker_compose_lab_attacker_image }}
    container_name: {{ docker_compose_lab_attacker_name }}
    build:
      context: .
      dockerfile: Dockerfile.attacker
    command: ["sleep", "infinity"]
    tty: true
    cap_add:
      - NET_ADMIN
      - NET_RAW
    networks:
      labnet:
        ipv4_address: {{ docker_compose_lab_attacker_ip }}

  victim:
    image: {{ docker_compose_lab_victim_image }}
    container_name: {{ docker_compose_lab_victim_name }}
    ports:
      - "{{ docker_compose_lab_victim_port }}:80"
    volumes:
      - "./victim_html:/usr/share/nginx/html:ro"
    networks:
      labnet:
        ipv4_address: {{ docker_compose_lab_victim_ip }}

  evebox:
    image: {{ docker_compose_lab_evebox_image }}
    container_name: {{ docker_compose_lab_evebox_name }}
    ports:
      - "{{ docker_compose_lab_evebox_port }}:5636"
    volumes:
      - "/var/log/suricata:/var/log/suricata:ro"
      - "./evebox_data:/data"
    command: ["evebox", "server", "-D", "/data", "--datastore", "sqlite", "--input", "/var/log/suricata/eve.json", "--host", "0.0.0.0", "--no-auth", "--no-tls"]
    networks:
      labnet:
        ipv4_address: {{ docker_compose_lab_evebox_ip }}

  # Уязвимость: Shellshock (CVE-2014-6271)
  shellshock:
    image: vulnerables/cve-2014-6271
    container_name: shellshock_victim
    ports:
      - "8080:80"
    networks:
      labnet: {}

  # Уязвимость: vsftpd backdoor (CVE-2011-2523)
  ftp_victim:
    image: clintmint/vsftpd-2.3.4:1.0
    container_name: ftp_victim
    restart: unless-stopped
    command: ["sh", "-c", "start-vsftpd && sleep infinity"]
    networks:
      labnet:
        ipv4_address: 172.16.90.15
    ports:
      - "21:21"
      - "6200:6200"

  victim-juice-shop:
    image: bkimminich/juice-shop:latest
    container_name: victim-juice-shop
    hostname: victim-juice-shop
    networks:
      labnet:
        ipv4_address: 172.16.90.40
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production

  # --- Новые сервисы (интегрированные) ---

  # Уязвимая служба 1: Apache ActiveMQ (RCE - CVE-2023-46604)
  victim-activemq:
    image: vulhub/activemq:5.16.5
    container_name: victim-activemq
    hostname: victim-activemq
    networks:
      labnet:
        ipv4_address: 172.16.90.101  # IP изменен под подсеть labnet
    ports:
      - "61616:61616"
      - "8161:8161"

  # Уязвимая служба 2: Redis (Unauthorized Access + RCE)
  victim-redis:
    image: redis:5.0.7
    container_name: victim-redis
    hostname: victim-redis
    networks:
      labnet:
        ipv4_address: 172.16.90.102  # IP изменен под подсеть labnet
    ports:
      - "6379:6379"
    command: redis-server --bind 0.0.0.0 --protected-mode no --save ""

  # Уязвимая служба 3: MinIO Cluster (Information Disclosure - CVE-2023- 28432)
  # MinIO Node 1
  victim-minio-node1:
    image: vulhub/minio:2023-02-27T18-10-45Z
    container_name: victim-minio-node1
    hostname: victim-minio-node1
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin-vulhub
    networks:
      labnet:
        ipv4_address: 172.16.90.103  # IP изменен под подсеть labnet
    ports:
      - "9000:9000"
      - "9001:9001"
    command:
      - minio
      - server
      - --console-address
      - :9001
      - http://victim-minio-node1:9000/mnt/data1
      - http://victim-minio-node2:9000/mnt/data2
      - http://victim-minio-node3:9000/mnt/data3
    volumes:
      - minio_data1:/mnt/data1

  # MinIO Node 2
  victim-minio-node2:
    image: vulhub/minio:2023-02-27T18-10-45Z
    container_name: victim-minio-node2
    hostname: victim-minio-node2
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin-vulhub
    networks:
      labnet:
        ipv4_address: 172.16.90.113  # IP изменен под подсеть labnet
    command:
      - minio
      - server
      - http://victim-minio-node1:9000/mnt/data1
      - http://victim-minio-node2:9000/mnt/data2
      - http://victim-minio-node3:9000/mnt/data3
    volumes:
      - minio_data2:/mnt/data2

  # MinIO Node 3
  victim-minio-node3:
    image: vulhub/minio:2023-02-27T18-10-45Z
    container_name: victim-minio-node3
    hostname: victim-minio-node3
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin-vulhub
    networks:
      labnet:
        ipv4_address: 172.16.90.114  # IP изменен под подсеть labnet
    command:
      - minio
      - server
      - http://victim-minio-node1:9000/mnt/data1
      - http://victim-minio-node2:9000/mnt/data2
      - http://victim-minio-node3:9000/mnt/data3
    volumes:
      - minio_data3:/mnt/data3

  # Уязвимая служба 4: Samba (RCE - CVE-2017-7494)
  victim-samba:
    image: vulhub/samba:4.6.3
    container_name: victim-samba
    hostname: victim-samba
    networks:
      labnet:
        ipv4_address: 172.16.90.104  # IP изменен под подсеть labnet
    ports:
      - "445:445"
      - "6699:6699"
    volumes:
      - ./smb.conf:/etc/samba/smb.conf:ro
    tty: true

  # Уязвимая служба 5: Jenkins (RCE - CVE-2024-23897)
  victim-jenkins:
    image: vulhub/jenkins:2.441
    container_name: victim-jenkins
    hostname: victim-jenkins
    networks:
      labnet:
        ipv4_address: 172.16.90.105  # IP изменен под подсеть labnet
    ports:
      - "8081:8080"  # ИЗМЕНЕНО: 8081 чтобы не конфликтовать с shellshock (8080)
      - "50000:50000"
      - "5005:5005"
    init: true
    environment:
      - DEBUG=1

volumes:
  minio_data1:
  minio_data2:
  minio_data3:

networks:
  labnet:
    name: {{ docker_compose_lab_network_name }}
    driver: bridge
    ipam:
      config:
        - subnet: {{ docker_compose_lab_network_subnet }}